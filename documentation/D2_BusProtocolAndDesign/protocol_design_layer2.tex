\subsection{media access and fault tolerance layer}
\label{sec:bus:design:layer2}

The second layer of our protocol can be seen as a composition of two internal layers, 
namely the media access sublayer controling the basic bus access as depicted in section 
\ref{sec:bus:basicaccess} \nameref{sec:bus:basicaccess} and the state machine defining 
the communication process and the fault tolerant sublayer providing basic fault 
tolerant mechnaisms like the FTNSH (see section \ref{sec:bus:ftnsh}) \nameref{sec:bus:ftnsh}).\\

These two sublayers and their interactions are described in the sections 
\ref{sec:bus:design:layer2:mac} \nameref{sec:bus:design:layer2:mac} and 
\ref{sec:bus:design:layer2:ft} \nameref{sec:bus:design:layer2:ft} in detail. 
In the following section we describe the general workflow of the Mac \& FT layer.\\

\subsubsection{general workflow}

To describe the general workflow of the Mac \& FT layer we examine how messages are sent and received.\\

\textbf{transmission of messages}\\
When a higher layer (including the application) wants to send a message it adds the message to the \textit{Send Msg Queue} which is provided
by a ring buffer holding all the messages payloads and the messages types. The highest prior message is stored in the protocols state machine, waiting for the bus to be free.\\

When the bus seems to be free, e.g. the transmission of a previous message has completed, the protocol tries to arbitrate the bus via the message type delivered through the message description held in the queue.\\

If the arbitration was successful the rest of the message is transmitted and the next message from the queue is fetched into the protocols finite state machine. Otherwise the message is kept in the finite state machine of the protocol and retransmitted when the bus is free again.
Whenever there was a transmission attempt wheter successful or not a callback routine is fired propagating the current status of the protocol to higher level layers or to the flags and registers seperating the application from the communication network interface.\\

\textbf{reception of messages}\\
When the USART reports the receiption of data the protcol changes in a receiving state 


\subsubsection{media access sublayer in detail}
\label{sec:bus:design:layer2:mac}


\subsubsection{fault tolerance sublayer in detail}
\label{sec:bus:design:layer2:ft}


 